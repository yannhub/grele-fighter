<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>D√©fense contre la Gr√™le - G2S</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Arial", sans-serif;
      }

      body {
        background-color: #f0f8ff;
        color: #333;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .logo {
        width: 150px;
        height: auto;
      }

      h1 {
        color: #007540;
        text-align: center;
        margin: 10px 0;
      }

      .content {
        display: flex;
        flex-grow: 1;
      }

      .game-area {
        flex: 3;
        padding: 20px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      }

      .leaderboard {
        flex: 1;
        margin-left: 20px;
        padding: 20px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      }

      .leaderboard h2 {
        color: #007540;
        margin-bottom: 15px;
        text-align: center;
      }

      .leaderboard-list {
        list-style-type: none;
      }

      .leaderboard-list li {
        padding: 10px;
        border-bottom: 1px solid #eee;
        font-weight: bold;
      }

      .leaderboard-list li span {
        float: right;
        color: #007540;
      }

      .welcome {
        text-align: center;
        margin: 20px 0;
      }

      .welcome img {
        max-width: 200px;
        margin: 20px auto;
        display: block;
      }

      .prize {
        background-color: #f9f9c6;
        border: 2px dashed #ffc107;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        margin: 20px auto;
        max-width: 500px;
      }

      .prize h3 {
        color: #e65100;
        margin-bottom: 10px;
      }

      button {
        background-color: #007540;
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 18px;
        border-radius: 5px;
        cursor: pointer;
        margin: 10px 0;
        transition: background-color 0.3s;
      }

      button:hover {
        background-color: #005a32;
      }

      .start-btn {
        display: block;
        width: 200px;
        margin: 20px auto;
      }

      .register-form {
        max-width: 400px;
        margin: 0 auto;
        display: none;
      }

      .register-form input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      .instruction {
        background-color: #e8f5e9;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        display: none;
      }

      .instruction h3 {
        color: #007540;
        margin-bottom: 10px;
      }

      .instruction ul {
        margin-left: 20px;
      }

      .instruction li {
        margin: 5px 0;
      }

      #game-canvas {
        display: none;
        border: 2px solid #007540;
        margin: 0 auto;
        background-color: #e8f5e9;
      }

      #score-display {
        font-size: 24px;
        font-weight: bold;
        color: #007540;
        text-align: center;
        margin: 10px 0;
        display: none;
      }

      #game-over {
        display: none;
        text-align: center;
        margin: 20px 0;
      }

      #final-score {
        font-size: 32px;
        color: #007540;
        margin: 10px 0;
      }

      .wheat-field {
        background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23e8d985"/><path d="M0,0 L100,100 M100,0 L0,100" stroke="%23d4c76c" stroke-width="1"/></svg>');
      }

      .defender {
        width: 50px;
        height: 50px;
        background-color: #007540;
        border-radius: 50%;
        position: relative;
      }

      .hail {
        width: 20px;
        height: 20px;
        background-color: #a8cef0;
        border-radius: 50%;
        position: absolute;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      }

      .bullet {
        width: 10px;
        height: 10px;
        background-color: #ffeb3b;
        border-radius: 50%;
        position: absolute;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <img
          src="./assets/img/g2s-logo.jpeg"
          alt="G2S Logo"
          class="logo"
        />
        <h1>D√©fense contre la Gr√™le</h1>
      </header>

      <div class="content">
        <div class="game-area">
          <div id="welcome-screen" class="welcome">
            <h2>Bienvenue au jeu de d√©fense contre la gr√™le!</h2>
            <p>Prot√©gez les champs de bl√© contre les temp√™tes de gr√™le!</p>

            <div class="prize">
              <h3>üèÜ GRAND PRIX üèÜ</h3>
              <p>
                Le meilleur score de la journ√©e remportera un magnifique panier
                de fruits et l√©gumes frais!
              </p>
              <img
                src="./assets/img/panier-legumes.png"
                alt="Panier de fruits et l√©gumes"
              />
            </div>

            <button id="start-btn" class="start-btn">COMMENCER</button>
          </div>

          <form id="register-form" class="register-form">
            <h3>Entrez vos informations</h3>
            <input type="text" id="firstname" placeholder="Pr√©nom" required />
            <input type="text" id="lastname" placeholder="Nom" required />
            <input type="text" id="nickname" placeholder="Pseudo (optionnel)" />
            <button type="submit" id="submit-info">SUIVANT</button>
          </form>

          <div id="game-instructions" class="instruction">
            <h3>Comment jouer</h3>
            <ul>
              <li>
                Utilisez les touches <strong>fl√®ches gauche</strong> et
                <strong>fl√®che droite</strong> pour d√©placer votre d√©fenseur
              </li>
              <li>
                Appuyez sur la <strong>barre d'espace</strong> pour tirer et
                d√©truire les gr√™lons
              </li>
              <li>
                Prot√©gez vos champs de bl√© en emp√™chant les gr√™lons d'atteindre
                le sol
              </li>
              <li>Chaque gr√™lon d√©truit vous rapporte 10 points</li>
              <li>
                Le jeu s'acc√©l√®re au fur et √† mesure de votre progression!
              </li>
            </ul>
            <button id="play-btn">JOUER</button>
          </div>

          <div id="score-display">Score: <span id="current-score">0</span></div>

          <canvas id="game-canvas" width="600" height="400"></canvas>

          <div id="game-over">
            <h2>Partie termin√©e!</h2>
            <p>Votre score final:</p>
            <div id="final-score">0</div>
            <button id="play-again-btn">REJOUER</button>
          </div>
        </div>

        <div class="leaderboard">
          <h2>Classement</h2>
          <ul id="leaderboard-list" class="leaderboard-list">
            <!-- Les scores seront ajout√©s ici dynamiquement -->
          </ul>
        </div>
      </div>
    </div>

    <script>
      // √âl√©ments DOM
      const welcomeScreen = document.getElementById("welcome-screen");
      const registerForm = document.getElementById("register-form");
      const gameInstructions = document.getElementById("game-instructions");
      const gameCanvas = document.getElementById("game-canvas");
      const scoreDisplay = document.getElementById("score-display");
      const currentScoreEl = document.getElementById("current-score");
      const gameOverScreen = document.getElementById("game-over");
      const finalScoreEl = document.getElementById("final-score");
      const leaderboardList = document.getElementById("leaderboard-list");

      // Boutons
      const startBtn = document.getElementById("start-btn");
      const submitInfoBtn = document.getElementById("submit-info");
      const playBtn = document.getElementById("play-btn");
      const playAgainBtn = document.getElementById("play-again-btn");

      // Variables du jeu
      let canvas, ctx;
      let player = {
        x: 0,
        y: 0,
        width: 50,
        height: 30,
        speed: 5,
      };

      let bullets = [];
      let hails = [];
      let score = 0;
      let gameInterval;
      let hailInterval;
      let playerInfo = {};
      let gameSpeed = 1;
      let keys = {};

      // Gestion du localStorage pour les scores
      function getLeaderboard() {
        const leaderboard =
          JSON.parse(localStorage.getItem("greleDefenseLeaderboard")) || [];
        return leaderboard;
      }

      function saveScore(playerInfo, score) {
        let leaderboard = getLeaderboard();

        // Cr√©er une entr√©e pour le nouveau score
        const entry = {
          firstname: playerInfo.firstname,
          lastname: playerInfo.lastname,
          nickname:
            playerInfo.nickname ||
            `${playerInfo.firstname} ${playerInfo.lastname.charAt(0)}.`,
          score: score,
          date: new Date().toISOString(),
        };

        // Ajouter le nouveau score
        leaderboard.push(entry);

        // Trier par score d√©croissant
        leaderboard.sort((a, b) => b.score - a.score);

        // Limiter √† 10 entr√©es
        if (leaderboard.length > 10) {
          leaderboard = leaderboard.slice(0, 10);
        }

        // Sauvegarder dans le localStorage
        localStorage.setItem(
          "greleDefenseLeaderboard",
          JSON.stringify(leaderboard)
        );

        // Mettre √† jour l'affichage
        updateLeaderboardDisplay();
      }

      function updateLeaderboardDisplay() {
        const leaderboard = getLeaderboard();
        leaderboardList.innerHTML = "";

        if (leaderboard.length === 0) {
          const li = document.createElement("li");
          li.textContent = "Pas encore de scores";
          leaderboardList.appendChild(li);
          return;
        }

        leaderboard.forEach((entry, index) => {
          const li = document.createElement("li");
          li.innerHTML = `${index + 1}. ${entry.nickname} <span>${
            entry.score
          }</span>`;
          leaderboardList.appendChild(li);
        });
      }

      // Initialiser le jeu
      function initGame() {
        canvas = document.getElementById("game-canvas");
        ctx = canvas.getContext("2d");

        // Positionner le joueur
        player.x = canvas.width / 2 - player.width / 2;
        player.y = canvas.height - player.height - 10;

        // Ajouter les √©couteurs d'√©v√©nements pour le clavier
        window.addEventListener("keydown", function (e) {
          keys[e.key] = true;
        });

        window.addEventListener("keyup", function (e) {
          keys[e.key] = false;
        });

        // D√©marrer la boucle du jeu
        gameInterval = setInterval(gameLoop, 1000 / 60); // 60 FPS

        // G√©n√©rer des gr√™lons √† intervalles r√©guliers
        hailInterval = setInterval(createHail, 1000);

        // D√©marrer avec un score de 0
        score = 0;
        updateScore();
      }

      // Fonctions du jeu
      function gameLoop() {
        // Effacer le canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Dessiner le fond (champ de bl√©)
        drawBackground();

        // D√©placer et dessiner le joueur
        movePlayer();
        drawPlayer();

        // D√©placer et dessiner les balles
        moveBullets();
        drawBullets();

        // D√©placer et dessiner les gr√™lons
        moveHails();
        drawHails();

        // V√©rifier les collisions
        checkCollisions();

        // Augmenter progressivement la difficult√©
        gameSpeed += 0.0005;
      }

      function drawBackground() {
        ctx.fillStyle = "#e8d985";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Motif pour simuler des champs de bl√©
        ctx.strokeStyle = "#d4c76c";
        ctx.lineWidth = 1;

        for (let i = 0; i < canvas.width; i += 20) {
          ctx.beginPath();
          ctx.moveTo(i, 0);
          ctx.lineTo(i, canvas.height);
          ctx.stroke();
        }

        for (let i = 0; i < canvas.height; i += 20) {
          ctx.beginPath();
          ctx.moveTo(0, i);
          ctx.lineTo(canvas.width, i);
          ctx.stroke();
        }
      }

      function movePlayer() {
        if (keys["ArrowLeft"] && player.x > 0) {
          player.x -= player.speed;
        }
        if (keys["ArrowRight"] && player.x < canvas.width - player.width) {
          player.x += player.speed;
        }
        if (keys[" "] && bullets.length < 5) {
          // √âviter le spam en limitant le nombre de balles
          createBullet();
          // R√©initialiser la touche espace pour √©viter les tirs continus
          keys[" "] = false;
        }
      }

      function drawPlayer() {
        ctx.fillStyle = "#007540";
        ctx.fillRect(player.x, player.y, player.width, player.height);

        // Ajouter un canon sur le dessus
        ctx.fillStyle = "#005a32";
        ctx.fillRect(player.x + player.width / 2 - 5, player.y - 10, 10, 10);
      }

      function createBullet() {
        bullets.push({
          x: player.x + player.width / 2 - 5,
          y: player.y - 10,
          width: 5,
          height: 10,
          speed: 7,
        });
      }

      function moveBullets() {
        for (let i = 0; i < bullets.length; i++) {
          bullets[i].y -= bullets[i].speed;

          // Supprimer les balles qui sortent de l'√©cran
          if (bullets[i].y < 0) {
            bullets.splice(i, 1);
            i--;
          }
        }
      }

      function drawBullets() {
        ctx.fillStyle = "#ffeb3b";
        for (const bullet of bullets) {
          ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
        }
      }

      function createHail() {
        const size = Math.random() * 10 + 15; // Taille entre 15 et 25
        hails.push({
          x: Math.random() * (canvas.width - size),
          y: -size,
          size: size,
          speed: (Math.random() * 2 + 1) * gameSpeed,
        });

        // Augmenter la fr√©quence des gr√™lons avec le temps
        if (gameSpeed > 1.5 && Math.random() > 0.7) {
          createHail();
        }
      }

      function moveHails() {
        for (let i = 0; i < hails.length; i++) {
          hails[i].y += hails[i].speed;

          // V√©rifier si un gr√™lon a atteint le sol
          if (hails[i].y > canvas.height) {
            // Fin du jeu
            endGame();
            return;
          }
        }
      }

      function drawHails() {
        for (const hail of hails) {
          // Dessiner un gr√™lon (cercle blanc/bleut√©)
          ctx.fillStyle = "#a8cef0";
          ctx.beginPath();
          ctx.arc(
            hail.x + hail.size / 2,
            hail.y + hail.size / 2,
            hail.size / 2,
            0,
            Math.PI * 2
          );
          ctx.fill();

          // Ajouter un effet de brillance
          ctx.fillStyle = "#ffffff";
          ctx.beginPath();
          ctx.arc(
            hail.x + hail.size / 3,
            hail.y + hail.size / 3,
            hail.size / 6,
            0,
            Math.PI * 2
          );
          ctx.fill();
        }
      }

      function checkCollisions() {
        // V√©rifier les collisions entre les balles et les gr√™lons
        for (let i = 0; i < bullets.length; i++) {
          const bullet = bullets[i];

          for (let j = 0; j < hails.length; j++) {
            const hail = hails[j];

            // V√©rifier la collision (simple bo√Æte englobante)
            if (
              bullet.x < hail.x + hail.size &&
              bullet.x + bullet.width > hail.x &&
              bullet.y < hail.y + hail.size &&
              bullet.y + bullet.height > hail.y
            ) {
              // Collision d√©tect√©e
              bullets.splice(i, 1);
              i--;

              // Supprimer le gr√™lon
              hails.splice(j, 1);
              j--;

              // Augmenter le score
              score += 10;
              updateScore();

              break;
            }
          }
        }
      }

      function updateScore() {
        currentScoreEl.textContent = score;
      }

      function endGame() {
        // Arr√™ter les intervalles
        clearInterval(gameInterval);
        clearInterval(hailInterval);

        // Afficher l'√©cran de fin
        gameCanvas.style.display = "none";
        scoreDisplay.style.display = "none";
        gameOverScreen.style.display = "block";

        // Afficher le score final
        finalScoreEl.textContent = score;

        // Sauvegarder le score
        saveScore(playerInfo, score);
      }

      // Navigation entre les √©crans
      startBtn.addEventListener("click", function () {
        welcomeScreen.style.display = "none";
        registerForm.style.display = "block";
      });

      registerForm.addEventListener("submit", function (e) {
        e.preventDefault();

        // R√©cup√©rer les informations du joueur
        playerInfo = {
          firstname: document.getElementById("firstname").value,
          lastname: document.getElementById("lastname").value,
          nickname: document.getElementById("nickname").value,
        };

        // Passer aux instructions
        registerForm.style.display = "none";
        gameInstructions.style.display = "block";
      });

      playBtn.addEventListener("click", function () {
        // Masquer les instructions et afficher le jeu
        gameInstructions.style.display = "none";
        gameCanvas.style.display = "block";
        scoreDisplay.style.display = "block";

        // D√©marrer le jeu
        initGame();
      });

      playAgainBtn.addEventListener("click", function () {
        // R√©initialiser les √©l√©ments du jeu
        bullets = [];
        hails = [];
        gameSpeed = 1;

        // Masquer l'√©cran de fin
        gameOverScreen.style.display = "none";

        // Afficher le jeu
        gameCanvas.style.display = "block";
        scoreDisplay.style.display = "block";

        // D√©marrer une nouvelle partie
        initGame();
      });

      // Initialiser le leaderboard au chargement
      updateLeaderboardDisplay();
    </script>
  </body>
</html>
